<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Carteira - Kung Fu</title>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        form { display: flex; flex-direction: column; gap: 15px; }
        label { font-size: 0.9em; font-weight: bold; color: #555; margin-bottom: -10px; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 1em; }
        button { padding: 12px; background-color: #d32f2f; color: white; border: none; border-radius: 5px; font-size: 1.1em; cursor: pointer; transition: background 0.3s; font-weight: bold; }
        button:hover { background-color: #b71c1c; }
        .aviso { font-size: 0.8em; color: red; text-align: center;}
    </style>
</head>
<body>

    <div class="container">
        <h2>Emissão de Carteira</h2>
        
        <form id="carteiraForm">
            <label for="tipo">Tipo de Filiação</label>
            <select id="tipo" required>
                <option value="atleta.pdf">Atleta</option>
                <option value="professor.pdf">Professor</option>
                <option value="arbitro.pdf">Árbitro</option>
            </select>

            <label for="foto">Foto (3x4)</label>
            <input type="file" id="foto" accept="image/png, image/jpeg, image/jpg" required>

            <label for="nome">Nome Completo</label>
            <input type="text" id="nome" required>

            <label for="nascimento">Data de Nascimento</label>
            <input type="date" id="nascimento" required>

            <label for="estilo">Estilo / Graduação</label>
            <input type="text" id="estilo" placeholder="Ex: Faixa Preta" required>

            <label for="academia">Associação / Academia</label>
            <input type="text" id="academia" required>

            <label for="numero">Número Filiação:</label>
            <input type="text" id="numero" required>

            <button type="submit">Gerar Carteira</button>
        </form>
    </div>

    <script>
        const { PDFDocument, rgb } = PDFLib;

        const CALIBRATION_MODE = false;

        const DATA_VALIDADE = "29/02/2028";
        const POSICOES = {
            numero:     { x: 188, y: 98 },
            foto:       { x: 9.5, y: 12.8, w: 59, h: 79 },
            qrcode:     { x: 180, y: 14, w: 48, h: 48 }, 
            validade:   { x: 188, y: 75 },
            nome:       { x: 76, y: 79 },
            nascimento: { x: 76, y: 59 },
            estilo:     { x: 76, y: 37 },
            academia:   { x: 76, y: 15 }
        };

        document.getElementById('carteiraForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const tipoArquivo = document.getElementById('tipo').value;
            const nome = document.getElementById('nome').value.toUpperCase();
            const numero = document.getElementById('numero').value.toUpperCase();
            const dataRaw = document.getElementById('nascimento').value;
            const [ano, mes, dia] = dataRaw ? dataRaw.split('-') : ["0000", "00", "00"];
            const nascimento = `${dia}/${mes}/${ano}`;

            const estilo = document.getElementById('estilo').value.toUpperCase();
            const academia = document.getElementById('academia').value.toUpperCase();

            const fotoInput = document.getElementById('foto');
            if (fotoInput.files.length === 0) {
                alert("Por favor, selecione uma foto.");
                return;
            }
            const fotoFile = fotoInput.files[0];

            try {
                const frontBytes = await fetch(tipoArquivo).then(res => res.arrayBuffer());
                const pdfDoc = await PDFDocument.load(frontBytes);
                const frontPage = pdfDoc.getPages()[0];
                const { width, height } = frontPage.getSize();
                
                const fotoBytes = await fotoFile.arrayBuffer();
                let fotoImage;
                if (fotoFile.type === 'image/png') {
                    fotoImage = await pdfDoc.embedPng(fotoBytes);
                } else {
                    fotoImage = await pdfDoc.embedJpg(fotoBytes);
                }

                const qrBytes = await fetch('qr-code.png').then(res => res.arrayBuffer());
                const qrImage = await pdfDoc.embedPng(qrBytes);

                const fontSize = 6;
                const drawText = (text, pos, size = fontSize, color = rgb(0,0,0)) => {
                    frontPage.drawText(text || "", { x: pos.x, y: pos.y, size: size, color: color });
                };

                if (CALIBRATION_MODE) {
                    const drawRect = (pos, label) => {
                        frontPage.drawRectangle({
                            x: pos.x, y: pos.y, width: pos.w, height: pos.h,
                            borderColor: rgb(1, 0, 0), borderWidth: 1,
                        });
                        frontPage.drawText(label, { x: pos.x, y: pos.y + pos.h + 2, size: 6, color: rgb(1, 0, 0) });
                    };

                    drawRect(POSICOES.foto, "FOTO");
                    drawRect(POSICOES.qrcode, "QR");
                    
                    for (let y = 0; y < height; y += 10) {
                        frontPage.drawLine({ start: { x: 0, y: y }, end: { x: width, y: y }, color: rgb(1, 0, 0), opacity: 0.3, thickness: 0.5 });
                    }
                    for (let x = 0; x < width; x += 20) {
                        frontPage.drawLine({ start: { x: x, y: 0 }, end: { x: x, y: height }, color: rgb(1, 0, 0), opacity: 0.3, thickness: 0.5 });
                    }

                    drawText("NOME", POSICOES.nome, 6, rgb(1,0,0));
                    drawText("VALIDADE", POSICOES.validade, 6, rgb(1,0,0)); 

                } else {
                    frontPage.drawImage(fotoImage, {
                        x: POSICOES.foto.x, y: POSICOES.foto.y,
                        width: POSICOES.foto.w, height: POSICOES.foto.h,
                    });

                    frontPage.drawImage(qrImage, {
                        x: POSICOES.qrcode.x, y: POSICOES.qrcode.y,
                        width: POSICOES.qrcode.w, height: POSICOES.qrcode.h,
                    });

                    drawText(nome, POSICOES.nome);
                    drawText(nascimento, POSICOES.nascimento);
                    drawText(estilo, POSICOES.estilo);
                    drawText(academia, POSICOES.academia);
                    drawText(numero, POSICOES.numero);
                    drawText(DATA_VALIDADE, POSICOES.validade); 
                }

                const backBytes = await fetch('verso.pdf').then(res => res.arrayBuffer());
                const backPdf = await PDFDocument.load(backBytes);
                const [versoPage] = await pdfDoc.copyPages(backPdf, [0]);
                pdfDoc.addPage(versoPage);

                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `Carteira_${nome.replace(/\s+/g, '_')}.pdf`;
                link.click();

            } catch (error) {
                console.error(error);
                alert("Erro! Verifique os arquivos na pasta e o console (F12) para detalhes.");
            }
        });
    </script>
</body>
</html>